<?php

if (!defined('_PS_VERSION_'))
	exit;


class Fozzy_sampling_small extends Module
{
	protected $html = '';

	public function __construct()
	{
		$this->name = 'fozzy_sampling_small';
		$this->tab = 'pricing_promotion';
		$this->version = '1.0.0';
		$this->author = 'Novevision.com, Britoff A.';
		$this->need_instance = 1;

		$this->bootstrap = true;
		parent::__construct();

		$this->displayName = $this->l('Customer rewards carusel');
		$this->description = $this->l('Provide a loyalty program to your customers.');
	}

	public function install()
	{
		if (!parent::install() 
    || !$this->registerHook('displayShoppingCart')
    
    )
			return false;
		return true;
	}

	public function uninstall()
	{
		if (!parent::uninstall())
			return false;
		return true;
	}

  public function hookdisplayShoppingCart($params) {
  
  $cart = $params['cart'];
 
  $rules = $cart->getProducts(true);
  
  $gift_added = 0;
  if ($rules) foreach ($rules as $rule)
    {
      if ($rule['id_product'] == 57191 || $rule['id_product'] == 57193) 
      {
       $gift_added = 1;
       break;
      }
      else $gift_added = 0;
    }

 // $this->context->controller->addCSS($this->_path.'fozzy_sampling_small.css', 'all');  
  if ( !$gift_added ) 
    {
   //   d($cart);
  
    
    $this->context->smarty->assign(array(
              'id_cart' => $cart->id,
          ));
        
    return $this->display(__FILE__, 'fozzy_sampling_small.tpl');
   }
   
   
   
  }

  private function _registergift($id_customer = null, $gift_product_code, $cartrule, $gift_product, $cart_id)
  {
    //   $sql = "INSERT INTO `"._DB_PREFIX_."fozzy_sampling_small_clients` (`id_client`, `id_product_s`, `cartrule`, `id_product`, `cart_id`) VALUES (".$id_customer.",".$gift_product_code.",'".$cartrule."',".$gift_product.",".$cart_id.")";
   //    Db::getInstance()->execute($sql);
  }
  
  private function _getnextgift($id_customer = null, $cart_products = null)    //Добавить проверку на пол
  {
     
     $gift = array();
     $id_shop = (int)$this->context->shop->id;
     
        // Новый клиент, выдача товаров строго случайная, по другому никак. Только товары помеченные новым клиентам.
        $sql = 'SELECT sp.`id_product_s`, sp.`id_product` FROM `'._DB_PREFIX_.'fozzy_sampling_small_products` sp LEFT JOIN `'._DB_PREFIX_.'stock_available` st ON (st.`id_product`=sp.`id_product`) WHERE sp.`active` = 1 AND (st.`id_shop` = '.$id_shop.') AND (st.`quantity` > 0) ';
        $sql.= ' ORDER BY RAND() LIMIT 1';
        $gift = Db::getInstance()->executeS($sql);
     return $gift[0];
     
  }

  public function AddGift($id_cart) {
  
  $cart = new Cart ($id_cart);
  $id_shop = (int)$cart->id_shop;
  /*
  $borjomi = array(906,1008,3316,14240,534443,723124,771313,790206);
  $spell = array(38064,43702,54290,48819,50569,50572,64104,8818,38018,38019,38020,38021,38041,48820,12568,12569,12600,33759,62722,62723,62724,60717,62713,62969,62970,62971,59592,12611,31249,31324,31199,8176,61671,48821,17545,49547,8424,37835,43198,38022,33755,33756,33757,43670,62762,63565,63568,64105,45901,8197,31235,43199,3362,31187,31189,38751,37778,37779,58871,61638,1585,44316,1493,1500,1501,44315,12610,47651,58872,3333,12601,58745,58746,62732,63567,52613,52397,52402,63570,56183,56184,56185,31124,54278,12604,31234,45964,31210,3303,3305,3306,38105,62721,8898,8899,8900,33743,8149,43002,60424,60425,60426,62734,1494,1495,1498,52547,12602,12605,52698,54280,1685,31195,43006,43007,46018,49724,5798,28774,39779,23789,12606,5841,12603,5840,16111,5916,5829,43624,38680,12614,12616,15803,16006,23907,28803,28804,28819,36571,36572,38542,38581,38582,38589,45525,49709,51088,52437,60089,61087,62566,62585,5906,62587,50257,5913,38678,1504,44348,38584,38585,23740,1410,17881,29278,5532,28945,43053,43054,5888,5893,28783,28801,28805,45460,52446,53559,61051,62473,62578,62593,15944,15945,16103,16105,59634,15943,15941,15942,15946,15948,15951,5643,23777,28773,28898,28899,1457,16104,59636,64638,59635,64733,5741,60103,16016,37799,37801,1506,31193,38598,38600,38679,16012,38538,1505,28799,43021,48145,49583,51093,51110,53296,58763,62586,17882,28732,38659,38660,38661,52543,52544,1684,49301,62729,62730,62731,45882,38596,38597,16014,16017,59633,63960,63961,38599,38595,1652,1686,3469,5644,23784,28809,34256,38577,38616,45464,49675,51064,51090,61056,62572,62575,62726,62727,62735,63561,17486,43031,52611,52612,43023,61079,43055,44302,43028,15791,23727,5759,5761,5762,5763,15831,15838,24053,28808,28810,28852,28853,37649,38508,38517,38571,38573,38575,38590,39796,43000,43001,48984,49702,51069,51071,52451,52552,60420,60421,60794,61072,62567,62728,5730,16013,16015,16018,16019,52539,52540,43032,40644,38488,61062,45522,17889,38525,38526,43017,46736,48137,48140,48986,48987,52444,61023,44346,3367,28845,45527,43027,43030,28837,37651,38509,38578,38580,43043,45523,51083,38491,5558,15789,15790,15792,15793,23715,23906,33786,33787,5915,38594,5890,15841,23724,28834,28836,28838,37713,38507,40640,40641,42996,42997,48985,49498,49643,49716,50272,51066,60107,60931,62582,62594,60427,60428,63950,5833,5838,5799,3410,23726,3457,12615,23760,28846,36272,39798,45469,59899,60099,60796,60881,62573,62588,62589,62733,5908,5800,43056,38524,43081,46737,43020,5482,3409,1448,1449,1452,23738,23904,33788,33789,38015,38547,38592,52441,56106,60800,60835,62590,44301,48147,5914,2474,58873,36574,26852,43060,3411,3408,58621,23732,38593,50029,53297,60091,60789,60882,60896,61068,61088,61089,62568,62581,37854,48148,5646,23853,38549,52440,63566,49298,43059,26811,37613,43019,49536,51063,53575,60419,60829,60830,28923,59597,31123,28926,2166,5891,38907,38908,43022,43036,51079,60836,60865,60940,61076,61081,61090,61091,62592,62600,36556,15496,29277,45961,2255,2274,3483,15795,23663,26810,34252,45463,52442,52445,61016,62569,62571,36729,45569,8939,1638,12613,19288,23776,28572,28791,38550,39795,39807,39810,45457,48136,49567,52452,58618,60827,60853,60930,61028,61067,45573,39778,62696,16172,16173,28826,1539,36743,36745,2277,17861,26813,1823,2402,43011,43012,15808,8413,48946,60837,2328,48956,28850,38574,39808,45449,47653,47655,47659,50575,51025,53250,58760,60813,60868,60884,60965,60971,62577,36076,36077,49302,1628,12540,23779,23665,28562,28851,38579,43091,45497,49431,49834,49845,60850,60939,60996,61010,1796,46990,2276,1808,1835,28820,36268,38497,43015,43049,60849,62595,36403,63580,64189,2514,26804,42998,49762,56093,26803,16135,16136,38496,38510,38532,38548,46046,47842,53576,60801,60814,60869,60909,60918,60953,60958,8155,43052,52393,52394,1781,28548,37655,60407,1666,1788,23806,51026,36742,40906,50032,52391,53686,60910,61020,28563,8147,2476,46719,1717,37705,43057,52392,60415,60792,60856,60864,60874,60875,60957,62570,56145,35596,31129,28849,38511,38643,43018,60803,60871,60902,60984,61069,28539,62698,62699,2515,23675,37646,38495,43095,51106,60825,60920,60934,63563,12539,28560,1624,1824,23905,28915,36158,38498,38601,39806,43033,45490,45491,48957,51072,51084,53248,56131,58617,59901,60412,60804,60806,60841,60848,60880,60892,60921,60961,60962,60968,60990,61008,61029,61074,43014,2261,1822,49808,49742,2395,56090,1815,23780,24058,45450,45500,60791,60847,60911,61027,56143,40627,28822,38554,38735,48144,51094,58761,58762,60956,60960,60972,61003,56196,56197,52545,1714,2259,5886,23132,51082,51091,53564,53565,60950,61084,23815,45448,47845,51146,60885,60889,61012,61013,61048,17866,56195,2265,1753,60997,60998,56092,45537,52546,60832,60844,60877,23809,37798,51085,53562,60933,60955,60973,61026,61038,61039,38752,38780,38781,1827,28900,45536,60842,61022,12536,53168,53169,38714,38910,61050,23812,49337,2516,31892,1696,1729,1806,16231,23676,36448,36598,38551,38644,45494,60812,60862,60872,60891,60908,60912,60928,60947,60952,60981,60987,61030,61031,61082,1705,16225,12535,53697,53971,17868,48143,60919,16004,45486,51077,60855,60983,23800,38748,15839,51073,51074,60917,60932,60980,43097,2260,53969,36438,15797,34459,49428,49662,60786,60903,60935,60959,60970,60976,60986,61070,1836,60846,60851,1598,2453,31194,1718,1772,16254,39820,48131,60417,60795,60831,2477,1800,23735,28544,40908,45526,60861,60963,61045,26840,42165,36573,46712,47847,2249,44238,44330,49820,40664,45528,49335,60858,60906,49565,2440,2449,38911,39805,49427,49789,50181,50182,60828,60840,60898,60974,61018,61041,61042,61052,53970,45881,28564,2263,2264,15830,51144,61044,23845,28534,43050,46738,50183,50186,60900,60922,61047,61085,61086,5673,48135,48138,49474,49673,60878,53689,1706,1707,1709,26824,50028,51081,60802,60863,60895,2471,45473,49515,50030,53558,61049,62565,43098,45499,48945,60409,48090,45568,1837,36162,60811,61040,36160,17705,2357,36517,45517,56099,28821,45484,60989,45923,43096,1715,1801,2469,38718,42990,43008,46045,60833,60860,60945,60988,61015,61025,1797,28546,38570,53246,60822,60923,60925,2517,45513,28568,35583,40630,49632,60817,61053,62697,2455,16204,28551,61002,2409,60978,49497,23680,23741,36203,40910,45519,45520,51148,60824,36472,17719,45570,23668,1602,46711,56096,53688,28533,46739,45539,53692,36473,45922,45489,16220,60818,60819,60857,43013,56103,23783,36294,60905,60977,61009,61071,38715,1830,2513,26825,28109,36298,52558,61014,49421,60798,60866,60867,60942,56097,36331,48466,54180,28561,49420,1794,2266,15824,28907,34255,36496,48797,50578,60793,60797,60799,60810,60873,60879,61021,43092,1716,1724,36748,37656,62700,33447,33469,45487,45918,17706,2410,36501,51145,60859,60924,61046,36252,23846,33451,38614,61043,45541,23798,33453,23730,40631,46055,48130,60838,60876,60887,60926,60948,60964,60993,61001,61060,61061,2373,2457,1838,17729,49614,53355,17707,60404,46718,2426,61004,50184,23814,28558,3393,40784,60787,60805,60807,60815,60821,60904,61033,61035,62564,38709,28107,1511,53161,56101,53163,28529,45454,60408,28555,26829,45511,45518,48139,53563,60788,60808,60944,60991,61006,61019,61032,26826,36497,46710,36382,36175,23670,60979,23659,22473,16230,28526,51147,53606,60938,61073,61078,26861,38717,28554,28542,64213,36494,2470,23813,28540,26866,36210,40653,45453,56098,60937,61005,61075,44156,38710,46052,49566,36209,2408,53695,36233,2472,17727,43715,60899,60943,60994,61000,53696,1541,1700,1702,1703,49622,23794,33446,23666,60941,60985,36492,36304,46051,33449,1793,23799,62701,1695,36208,60820,60845,61083,56102,23672,49621,2461,53691,53698,36189,36224,60854,60927,61024,61064,44161,56100,36225,46745,50189,45542,46048,36599,44162,43009,45516,60809,60954,53162,23683,50185,51152,56104,53264,45514,60823,23857,61063,38712,44158,37659,40663,44163,23657,36493,16221,49499,49677,37657,46714,23804,2460,37658,60410,1677,37851,60936,1799,60894,46713,23671,36495,36164,53226,53427,53428,28543,2446,46715,23681,44159,1451,2205,2425,2448,1816,33445,23797,2473,1819,52561,23796,44160,16236,45919,36502,48802);
  $products  =  $cart->getProducts();
  $id_customer = $cart->id_customer;
  
  $borjomi_gut = 0;
  $borjomi_avb = (int)StockAvailable::getQuantityAvailableByProduct(57194,null,$id_shop);
  $spell_gut = 0;
  $spell_avb = (int)StockAvailable::getQuantityAvailableByProduct(57192,null,$id_shop);

  foreach ($products as $product)
    {
      if (in_array($product['reference'], $borjomi)) $borjomi_gut = 1;
      
    }
   
   foreach ($products as $product)
    {
      if (in_array($product['id_product'], $spell)) 
        {
          $spell_gut = 1;
          $borjomi_gut = 0;   
        }
    }
   
      
//  if ($id_customer == 5 && $borjomi_gut && $borjomi_avb > 0)
  if ($borjomi_gut && $borjomi_avb > 0)
    {
    $cart -> updateQty (1,57194);
    header( 'Location: /cart?action=show', true, 303 );
    die();
    }
  
  if ($spell_gut && $spell_avb > 0)
    {
    $cart -> updateQty (1,57192);
    header( 'Location: /cart?action=show', true, 303 );
    die();
    }
  
  $gift_product_array = $this->_getnextgift($id_customer);
  $gift_product_code = $gift_product_array['id_product_s'];
  $gift_product = $gift_product_array['id_product'];
  */
  $gift_product = 57191;
  $gift_product_avb = (int)StockAvailable::getQuantityAvailableByProduct($gift_product,null,$id_shop);
  $gift_product_avb = 0;
  
  if ($gift_product_avb > 0) 
    {
      $cart->updateQty(1,$gift_product);
    }
  else
    {
      $gift_product = 57193;
      $gift_product_avb = (int)StockAvailable::getQuantityAvailableByProduct($gift_product,null,$id_shop);
      if ($gift_product_avb > 0) 
          {
            $cart->updateQty(1,$gift_product);
          }
    }  
  header( 'Location: /cart?action=show', true, 303 );
  
  }
  
  
  
  
  
  
  
}